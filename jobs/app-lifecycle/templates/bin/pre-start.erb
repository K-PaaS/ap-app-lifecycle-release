#!/bin/bash

set -e -u

##############################################################################
### BASE SETTING
##############################################################################

SCRIPT_NAME=$(basename $0)
JOB_NAME="app-lifecycle"
HOME_USER="vcap"
HOME_DIR="/var/vcap/data/lifecycle"
SETUP_HISTORY_DIR="${HOME_DIR}/.setup_history"
PKG_DIR="/var/vcap/packages/${JOB_NAME}"
JOB_DIR="/var/vcap/jobs/${JOB_NAME}"

RUN_DIR=/var/vcap/sys/run/${JOB_NAME}
LOG_DIR=/var/vcap/sys/log/${JOB_NAME}
TMP_DIR=/var/vcap/sys/tmp/${JOB_NAME}

function setup_environment() {

  for dir in ${RUN_DIR} ${LOG_DIR} ${TMP_DIR} ${SETUP_HISTORY_DIR}
  do
    mkdir -p ${dir}
    chown -R vcap:vcap ${dir}
    chmod 775 ${dir}
    echo "##### SETUP_ENVIRONMENT :: APP-LIFECYCLE :: ${dir}"
  done

}

setup_environment
source /var/vcap/packages/common/syslog_utils.sh
tee_output_to_sys_log_and_file ${LOG_DIR} ${SCRIPT_NAME}

echo "##### SETUP :: APP-LIFECYCLE :: tmp directory executable"
sudo mount -o remount,exec /tmp

##############################################################################
### APP-LIFECYCLE PRE-START :: dependencies
##############################################################################

if [ ! -e ${SETUP_HISTORY_DIR}/dependencies ]; then

    sudo apt update -y
    echo "##### SETUP :: APP-LIFECYCLE :: dependencies :: START"
    sudo apt install -y build-essential binutils-doc autoconf flex bison libjpeg-dev libfreetype6-dev zlib1g-dev libzmq3-dev libgdbm-dev libncurses5-dev automake libtool libffi-dev curl git tmux gettext

    echo "##### SETUP :: APP-LIFECYCLE :: dependencies :: END"
    touch ${SETUP_HISTORY_DIR}/dependencies
fi

##############################################################################
### APP-LIFECYCLE PRE-START :: mysql-client
##############################################################################

if [ ! -e ${SETUP_HISTORY_DIR}/mysql-client ]; then

    echo "##### SETUP :: APP-LIFECYCLE :: mariadb-client :: START"
    sudo apt install -y mariadb-client
    echo "##### SETUP :: APP-LIFECYCLE :: mariadb-client :: END"
    touch ${SETUP_HISTORY_DIR}/mysql-client
fi

##############################################################################
### CCE enable = <%= p('mariadb.cce_enable') %>
##############################################################################
  <% if p('mariadb.cce_enable') %>
if [ ! -e ${SETUP_HISTORY_DIR}/mysql-client-lib-CCE ]; then
  echo "##### SETUP :: APP-LIFECYCLE :: mysql-client-lib(CCE) :: START"

  sudo apt install apt-transport-https -y
  curl -sS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | sudo bash

  sudo apt-get install software-properties-common -y
  #sudo add-apt-repository 'deb [arch=amd64,arm64,ppc64el] http://sfo1.mirrors.digitalocean.com/mariadb/repo/10.3/ubuntu bionic main'

  sudo apt update -y

  sudo apt-get install libmariadbclient18 -y
  mkdir -p /usr/lib/mysql/plugin/
  cp /usr/lib/x86_64-linux-gnu/libmariadb3/plugin/client_ed25519.so  /usr/lib/mysql/plugin/
  mkdir -p /usr/lib/x86_64-linux-gnu/mariadb18/plugin/
  cp /usr/lib/x86_64-linux-gnu/libmariadb3/plugin/client_ed25519.so  /usr/lib/x86_64-linux-gnu/mariadb18/plugin/
  touch ${SETUP_HISTORY_DIR}/mysql-client-lib-CCE
  echo "##### SETUP :: APP-LIFECYCLE :: mysql-client-lib(CCE) :: END"
fi
  <% end %>

##############################################################################
### APP-LIFECYCLE PRE-START :: circus
##############################################################################

if [ ! -e ${SETUP_HISTORY_DIR}/circus ]; then

    echo "##### SETUP :: APP-LIFECYCLE :: circus :: START"
    sudo apt install -y circus

    sudo service circusd stop
    echo "##### SETUP :: APP-LIFECYCLE :: circus :: END"

    touch ${SETUP_HISTORY_DIR}/circus
fi

echo "##### SETUP :: APP-LIFECYCLE :: END "

